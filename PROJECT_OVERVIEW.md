# AutoContent TG — описание проекта

Проект автоматизирует подготовку и публикацию постов в Telegram-каналы. Он собирает материалы из RSS/URL источников, превращает их в черновики через LLM, позволяет отправлять черновики на ручное одобрение или публиковать автоматически по расписанию. Есть административный HTTP API для операций обслуживания, Telegram-бот для ежедневной работы, воркер для фоновых задач и база данных для хранения всех сущностей.

## Основные компоненты

- API (FastAPI): health-проверка и административные методы (списки проектов, источников, черновиков, запуск fetch, публикация черновика).
- Telegram-бот (aiogram): онбординг, настройка каналов, управление источниками, генерация черновиков, модерация и автопостинг.
- Воркер (Celery): фоновые задачи (fetch источников, генерация черновиков, публикации по расписанию).
- БД (Postgres + SQLAlchemy): проекты, пользователи, источники, материалы, черновики, публикации, расписания, логи.
- Redis: квоты, rate limit, idempotency для публикаций, cooldown/защита от спама команд.
- Интеграции: Telegram API, RSS/URL загрузчики, LLM-провайдер.

## Что умеет проект

- Создаёт проект и пользователя при первом /start (онбординг: язык, ниша, тон).
- Подключает Telegram-канал и проверяет права бота на публикацию.
- Принимает RSS и URL источники, отслеживает статус и ошибки источников.
- Fetch источников: скачивает новые материалы, дедуплицирует по внешнему идентификатору/ссылке.
- Генерация черновиков через LLM с использованием шаблонов (presets) и настроек проекта.
- Список черновиков, отдельная очередь «на одобрение» (safe mode).
- Публикация: вручную (бот/админ API) или автоматически по расписанию.
- Автопостинг: слоты времени, лимит публикаций в день, включение/выключение.
- Безопасность: safe mode по умолчанию, автопостинг выключен.
- Квоты и лимиты: лимиты на LLM-вызовы, черновики/публикации в день, публикации в час.
- Логи публикаций и статусы (успешно/ошибка), обработка ошибок публикации.
- Health-check API и инфраструктурные скрипты (docker, миграции, бэкапы).

## Ручные проверки (полный функциональный охват)

1) API доступность
- `GET /healthz` возвращает `ok`.
- Без `X-API-Key` любой `GET /admin/*` → 401.

2) Админ API
- `GET /admin/projects` возвращает список проектов.
- `GET /admin/projects/{id}/sources` показывает источники и ошибки.
- `GET /admin/projects/{id}/drafts` фильтрует по статусу.
- `POST /admin/projects/{id}/run_fetch` возвращает `items_saved` и создаёт новые SourceItem.
- `POST /admin/drafts/{id}/publish` публикует черновик и возвращает статус/лог.

3) Онбординг бота
- `/start` запускает цепочку язык/ниша/тон и создаёт проект.
- После онбординга отображается чеклист следующих шагов.

4) Привязка канала
- «Подключить канал» запрашивает канал и сохраняет связку.
- «Проверить» подтверждает права бота на постинг (успех/ошибка).

5) Источники
- Добавление RSS источника создаёт запись со статусом `active`.
- Добавление URL источника создаёт запись со статусом `active`.
- «Список источников» отображает все источники и статусы.
- Повторное добавление того же источника отрабатывает как дубль (ошибка или игнор).

6) Fetch и дедупликация
- «Fetch now» тянет материалы и создаёт SourceItem.
- Повторный fetch не создаёт дублей по `external_id` или `link`.
- При ошибке источника сохраняется `last_error`.

7) Черновики и LLM
- «Сгенерировать сейчас» создаёт новый черновик из новых материалов.
- Шаблон можно переключить из меню «Шаблоны».
- Пустые/невалидные материалы не дают черновик (или создают с ошибкой).
- Потребление лимитов LLM отражается в квотах.

8) Очередь одобрения (safe mode)
- При `safe_mode=true` новые черновики получают статус `needs_approval`.
- Ручное одобрение переводит черновик в `approved`.

9) Ручная публикация
- Публикация из бота создаёт запись в логах публикаций.
- Повторная публикация того же черновика обрабатывается идемпотентно.
- Ошибка Telegram (нет прав/не найден канал) корректно отображается пользователю.

10) Автопостинг и расписание
- «Автопостинг: Вкл/Выкл» меняет состояние.
- «Автопостинг: Слоты» сохраняет список времени (валидирует формат).
- «Автопостинг: Лимит» сохраняет дневной лимит.
- Воркер публикует черновики только в пределах слотов и лимитов.

11) Квоты и лимиты
- `DRAFTS_PER_DAY`, `PUBLISHES_PER_DAY`, `LLM_CALLS_PER_DAY` реально ограничивают действия.
- `PUBLISHES_PER_HOUR` блокирует частую публикацию.

12) Надёжность и инфраструктура
- Миграции применяются без ошибок (`make migrate`).
- Worker стартует и забирает задания (Celery + Redis).
- Логи ошибок попадают в Sentry при заданном `SENTRY_DSN`.
